<!DOCTYPE html>
<html lang="en">
<head>
    <style type="text/css">
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .chart {
            width: calc(50% - 10px);
            margin-bottom: 20px;
        }

        input {
            display: block; /* 把input元素变成块状元素 */
            margin: 0 auto; /* 把左右margin都设置为auto */
        }


    </style>
    <meta charset="UTF-8">
    <title>成都信息工程大学气象局--cuit气候中心--气候系统监测·诊断·预测·评估</title>
    <script src="https://cdn.staticfile.org/echarts/3.1.6/echarts.min.js"></script>
    <script src="https://www.makeapie.cn/dep/echarts/map/js/china.js"></script>
        <script src="http://www.ncc-cma.net/api_cmdp"></script>
</head>
<body onload="getData()">
<div id="main_box">
    <div id="main_right">
        <div class="detail_box1">

            <div id="zhuanti_detail">

                <a name='_search_'></a>
                <!--                <form method='post' action='http://localhost:3000/weather'>-->
                <p align='center'>

                    日期查询：<select name=Year id="year" onchange="getData()">
                    <option value=''>年份</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                    <option value="2013">2013</option>
                    <option value="2012">2012</option>
                    <option value="2011">2011</option>
                    <option value="2010">2010</option>
                    <option value="2009">2009</option>
                    <option value="2008">2008</option>
                    <option value="2007">2007</option>
                    <option value="2006">2006</option>
                    <option value="2005">2005</option>
                    <option value="2004">2004</option>
                    <option value="2003">2003</option>
                    <option value="2002">2002</option>
                    <option value="2001">2001</option>
                    <option value="2000">2000</option>
                    <option value="1999">1999</option>
                    <option value="1998">1998</option>
                    <option value="1997">1997</option>
                    <option value="1996">1996</option>
                    <option value="1995">1995</option>
                    <option value="1994">1994</option>
                    <option value="1993">1993</option>
                    <option value="1992">1992</option>
                    <option value="1991">1991</option>
                    <option value="1990">1990</option>
                    <option value="1989">1989</option>
                    <option value="1988">1988</option>
                    <option value="1987">1987</option>
                    <option value="1986">1986</option>
                    <option value="1985">1985</option>
                    <option value="1984">1984</option>
                    <option value="1983">1983</option>
                    <option value="1982">1982</option>
                    <option value="1981">1981</option>
                    <option value="1980">1980</option>
                    <option value="1979">1979</option>
                    <option value="1978">1978</option>
                    <option value="1977">1977</option>
                    <option value="1976">1976</option>
                    <option value="1975">1975</option>
                    <option value="1974">1974</option>
                    <option value="1973">1973</option>
                    <option value="1972">1972</option>
                    <option value="1971">1971</option>
                    <option value="1970">1970</option>
                    <option value="1969">1969</option>
                    <option value="1968">1968</option>
                    <option value="1967">1967</option>
                    <option value="1966">1966</option>
                    <option value="1965">1965</option>
                    <option value="1964">1964</option>
                    <option value="1963">1963</option>
                    <option value="1962">1962</option>
                    <option value="1961" selected>1961</option>
                </select>
                    <select name=Month id="month" onchange="getData()">
                        <option value=''>月</option>
                        <option value="06" selected>6</option>
                        <option value="07">7</option>
                        <option value="08">8</option>
                    </select>
                    &nbsp;
                </p>
                <div class="container">
                    <div class="chart" id="main" style="height: 400px;"></div>
                    <div class="chart" id="prb" style="height: 400px;"></div>
                    <div class="chart" id="new01" style="height: 400px;display: none"></div>
                    <div class="chart" id="new02" style="height: 400px;display: none"></div>
                    <label>
                        <input type="range" min='0' max='1' step='1' value='0' onchange="showDiv(this.value)">
                    </label>
                </div>

<!--                <div style="text-align: center;">-->
<!--                    <input type="range" min="0" max="1" step="1" value="0" onchange="showDiv(this.value)">-->
<!--                    <div id="main" style="width: 100%;height:100%;position: absolute;"></div>-->
<!--                    <div id="prb" style="width: 100%;height:100%;position: absolute;"></div>-->
<!--                    <div id="main" style="height: 400px;"></div>-->
<!--                    <div id="prb" style="height: 400px; display: none;"></div>-->
<!--                    <div id="prb" style="height: 400px;"></div>-->
<!--                    <input type="range" min='0' max='2' step='1' value='0' onchange="showDiv(this.value)">-->
<!--                </div>-->

                <script>
                    function getRainJson() {
                        const year = document.getElementById('year').value;
                        const month = document.getElementById('month').value;
                        //console.log(year, month);
                        /**
                         *
                         * @param jsonObj
                         * @returns {{[p: string]: any}}
                         */
                        const myChart = echarts.init(document.getElementById('main'));
                        function getGeoCoordMap(jsonObj) {
                            let geoCoordMap = new Map();
                            for (let info of jsonObj) {
                                geoCoordMap.set(info.Stanum, [parseInt(info.Lon) / 100, parseInt(info.Lat) / 100])
                                //console.log(info.Stanum,parseInt(info.Lat)/100,parseInt(info.Lon)/100);
                                //console.log(typeof parseInt(info.Lat))
                            }
                            const result = Object.fromEntries(geoCoordMap)
                            return result;
                        }

                        //let geoCoordMap = getGeoCoordMap(json);

                        function getNameValueArr(jsonObj) {
                            let nameValueArr = [];
                            for (let info of jsonObj) {
                                let currentNameValue = new Map();
                                currentNameValue.set('name', info.Stanum);
                                currentNameValue.set('value', info.Rain);
                                const currentResult = Object.fromEntries(currentNameValue)
                                nameValueArr.push(currentResult)
                            }
                            return nameValueArr;
                        }

                         async function findPlaceName(N,E){
                             const res = await fetch('anojson/anorain_1961_pre_06.json');
                             const json = await res.json();
                             for (let info of json) {
                                 if(info.Lat / 100 === N && info.Lon / 100 === E){
                                     console.log(info.Stanum)
                                     return info.Stanum;
                                 }
                             }
                             return '';
                        }

                        async function findCSV(N,E,month){
                            const placeName = await findPlaceName(N,E);
                            console.log(`${placeName}_${N}′N${E}′E_pre_${month}.csv`)
                            return `${placeName}_${N}′N${E}′E_pre_${month}.csv`;
                        }

                        function downloadFile(filename, doc) {
                            fetch('/' + doc + '/' + filename)
                                .then(response => response.blob())
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    a.click();
                                    window.URL.revokeObjectURL(url);
                                })
                                .catch(error => {
                                    console.error('下载文件失败：', error);
                                });
                        }

                        /**
                         * 根据年月、N、E获取对应的Mean,从这个目录anoJson下读
                         * @param N
                         * @param E
                         * @param year
                         * @param month
                         */
                        async function getMeanAndVar(N,E,year,month){
                            const filename = `anorain_${year}_pre_${month}.json`;
                            const res = await fetch('anojson/'+filename);
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Mean)
                                    return [info.Mean,info.Var];
                                }
                            }
                            return '';
                        }

                        var convertData = function (data, geoCoordMap) {
                            var res = [];
                            for (var i = 0; i < data.length; i++) {
                                var geoCoord = geoCoordMap[data[i].name];
                                if (geoCoord) {
                                    res.push(geoCoord.concat(data[i].value));
                                }
                            }
                            return res;
                        };

                        var blinkStyle = {
                            itemStyle: {
                                color: 'red',
                                // 添加闪烁动画
                                animation: {
                                    // 持续时间为 1 秒
                                    duration: 1000,
                                    // 循环播放
                                    loop: true,
                                },
                                // 添加感叹号图标
                                symbol: 'image://#exclamation',
                                symbolSize: 20,
                            },
                            emphasis: {
                                itemStyle: {
                                    opacity: 1
                                }
                            }
                        };

                        console.log(year, month)
                        fetch('anojson/anorain_'+year+'_pre_'+month+'.json')
                            .then((response) => response.json())
                            .then((json) => {
                                let geoCoordMap = getGeoCoordMap(json);
                                let nameValueArray = getNameValueArr(json);
                                //console.log("nameValueArray:", nameValueArray);
                                //console.log(typeof geoCoordMap)
                                const convertedData = convertData(nameValueArray, geoCoordMap);
                                //找到需要闪烁的点
                                //console.log("convertedData:", convertedData),
                                 option = {
                                    title: {
                                        text: '全国降水距平百分率分布图',
                                        subtext: year+'年'+month+'月',
                                        left: 'center',
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    backgroundColor: '#ffffff',
                                    visualMap: {
                                        type:'piecewise',
                                        pieces: [
                                            {min: 150}, // 不指定 max，表示 max 为无限大（Infinity）。
                                            {min: 100, max: 150},
                                            {min: 50, max: 100},
                                            {min: 20, max: 50},
                                            {min: 0, max: 20},
                                            {min: -20, max: 0},
                                            {min: -40, max: -20},
                                            {min: -60, max: -40},
                                            {min: -80, max: -60},
                                            {min: -100, max: -80},
                                        ],
                                        inRange: {
                                            color: ['DarkGreen','SeaGreen','SpringGreen','#ffff00','#ff7d40','#ff0000','#802a2a']
                                        },
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                     //新增图标
                                     graphic: {
                                         elements: [{
                                             type: 'image',
                                             id: 'exclamation',
                                             style: {
                                                 image: 'exclamation.png',
                                                 width: 20,
                                                 height: 20,
                                             },
                                         }],
                                     },
                                    geo: {
                                        map: 'china',
                                        label: {
                                            emphasis: {
                                                show: false
                                            }
                                        },
                                        roam: true,
                                        itemStyle: {
                                            normal: {
                                                areaColor: 'rgba(128, 128, 128, 0)'
                                            },
                                            emphasis:'disable',
                                            borderType:'dashed',
                                        }
                                    },
                                    series: [{
                                        name: 'AQI',
                                        type: 'scatter',
                                        coordinateSystem: 'geo',
                                        data: convertedData,
                                        emphasis: {
                                            label: {
                                                show: true,
                                            }
                                        },
                                    }],
                                    tooltip: {
                                        trigger: 'item',
                                        // formatter:function (params) {
                                        //     const mean =getMeanData(params.data[1], params.data[0], year, month);
                                        //     return '' + params.data[0] + '′E,' + params.data[1] + '′N<br/>value: ' + params.data[2] //+ '%<br/>mean:'+mean+ '<br/>var:' +params.data[4];
                                        // }
                                    },
                                };
                                myChart.setOption(option);

                                // 遍历数据，找到符合条件的数据项
                                var data = myChart.getOption().series[0].data;
                                var dataIndexs = [];
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i][2] > 120 || data[i][2] < -120) {
                                        dataIndexs.push(i);
                                    }
                                }
                                // 定义一个计数器，用于控制闪烁的速度
                                var count = 0;

// 定义一个定时器，用于控制闪烁的频率
                                var timer = setInterval(function() {
                                    // 遍历所有符合条件的数据项，通过 dispatchAction 方法触发 highlight 和 downplay 动作
                                    for (var i = 0; i < dataIndexs.length; i++) {
                                        var dataIndex = dataIndexs[i];
                                        myChart.dispatchAction({
                                            type: 'highlight',
                                            seriesIndex: 0,
                                            dataIndex: dataIndex,
                                            itemStyle: blinkStyle.itemStyle,
                                            emphasis: blinkStyle.emphasis
                                        });
                                    }

                                    setTimeout(function() {
                                        for (var i = 0; i < dataIndexs.length; i++) {
                                            var dataIndex = dataIndexs[i];
                                            myChart.dispatchAction({
                                                type: 'downplay',
                                                seriesIndex: 0,
                                                dataIndex: dataIndex
                                            });
                                        }
                                    }, 400);

                                    count++;
                                }, 800);

// 让定时器一直运行，直到页面卸载
                                window.addEventListener('unload', function() {
                                    clearInterval(timer);
                                });

                                //点击下载
                                // myChart.on('click',async function (params) {
                                //     // const CVSName = getCurrentCSV(params.data[1], params.data[0], month);
                                //     // console.log(CVSName)
                                //     const currentCSV =  await findCSV(params.data[1], params.data[0],month);
                                //     downloadFile(currentCSV,'stanvalueCsv');
                                // });

                                //点击跳转
                                myChart.on('click',async function (params) {
                                    const currentCSV =  await findCSV(params.data[1], params.data[0],month);
                                    const placeName = await findPlaceName(params.data[1], params.data[0]);
                                    const url = `linechart.html?csv=${currentCSV}&year=${year}&month=${month}&lat=${params.data[1]}&lon=${params.data[0]}&placeName=${placeName}`
                                    window.location.href = url;
                                })

                                myChart.on('mouseover',async function (params) {
                                    const result = await getMeanAndVar(params.data[1], params.data[0], year, month);
                                    myChart.setOption({
                                        tooltip: {
                                            formatter:function (params) {
                                                return `${params.data[0]}′E,${params.data[1]}′N<br/>value:${params.data[2]}${params.name}<br/>Mean：${result[0]}%<br/>Var：${result[1]}mm`
                                            }
                                        }
                                    })
                                });

                            })
                        //console.log("geoCoordMap:",geoCoordMap);

                    }


                </script>
                <script>
                    function getPrbJson() {
                        var blinkStyle = {
                            itemStyle: {
                                color: 'red', // 设置闪烁的颜色
                                borderWidth: 1,
                                borderColor: 'yellow',
                                opacity: 1,
                                shadowColor: 'yellow',
                                shadowBlur: 10
                            },
                            emphasis: {
                                itemStyle: {
                                    opacity: 1
                                }
                            }
                        };
                        const year = document.getElementById('year').value;
                        const month = document.getElementById('month').value;
                        //console.log(year, month);
                        /**
                         *
                         * @param jsonObj
                         * @returns {{[p: string]: any}}
                         */
                        const myChart02 = echarts.init(document.getElementById('prb'));
                        function getGeoCoordMap(jsonObj) {
                            let geoCoordMap = new Map();
                            for (let info of jsonObj) {
                                geoCoordMap.set(info.Stanum, [parseInt(info.Lon) / 100, parseInt(info.Lat) / 100])
                                //console.log(info.Stanum,parseInt(info.Lat)/100,parseInt(info.Lon)/100);
                                //console.log(typeof parseInt(info.Lat))
                            }
                            const result = Object.fromEntries(geoCoordMap)
                            return result;
                        }

                        //let geoCoordMap = getGeoCoordMap(json);

                        function getNameValueArr(jsonObj) {
                            let nameValueArr = [];
                            for (let info of jsonObj) {
                                let currentNameValue = new Map();
                                currentNameValue.set('name', info.Stanum);
                                currentNameValue.set('value', info.Rain);
                                const currentResult = Object.fromEntries(currentNameValue)
                                nameValueArr.push(currentResult)
                            }
                            return nameValueArr;
                        }
                        async function getMeanAndVar(N,E,year,month){
                            const filename = `anorain_${year}_pre_${month}.json`;
                            const res = await fetch('anojson/'+filename);
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Mean)
                                    return [info.Mean,info.Var];
                                }
                            }
                            return '';
                        }

                        var convertData = function (data, geoCoordMap) {
                            var res = [];
                            for (var i = 0; i < data.length; i++) {
                                var geoCoord = geoCoordMap[data[i].name];
                                if (geoCoord) {
                                    res.push(geoCoord.concat(data[i].value));
                                }
                            }
                            return res;
                        };
                        async function findPlaceName(N,E){
                            const res = await fetch('anojson/anorain_1961_pre_06.json');
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Stanum)
                                    return info.Stanum;
                                }
                            }
                            return '';
                        }

                        async function findCSV(N,E,month){
                            const placeName = await findPlaceName(N,E);
                            console.log(`${placeName}_${N}′N${E}′E_pre_${month}.csv`)
                            return `${placeName}_${N}′N${E}′E_pre_${month}.csv`;
                        }

                        function downloadFile(filename, doc) {
                            fetch('/' + doc + '/' + filename)
                                .then(response => response.blob())
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    a.click();
                                    window.URL.revokeObjectURL(url);
                                })
                                .catch(error => {
                                    console.error('下载文件失败：', error);
                                });
                        }

                        console.log(year, month)
                        fetch('prbJson/prbrain_'+year+'_pre_'+month+'.json')
                            .then((response) => response.json())
                            .then((json) => {
                                let geoCoordMap = getGeoCoordMap(json);
                                let nameValueArray = getNameValueArr(json);
                                //console.log("nameValueArray:", nameValueArray);
                                //console.log(typeof geoCoordMap)
                                var convertedData = convertData(nameValueArray, geoCoordMap);
                                //console.log("convertedData:", convertedData),
                                option = {
                                    title: {
                                        text: '卡方分布图',
                                        subtext: year+'年'+month+'月',
                                        left: 'center',
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    backgroundColor: '#ffffff',
                                    visualMap: {
                                        type:'piecewise',
                                        pieces: [
                                            {min: 60, max: 100},
                                            {min: 40, max: 60},
                                            {min: 20, max: 40},
                                            {min: 15, max: 20},
                                            {min: 10, max: 15},
                                            {min: 5, max: 10},
                                            {min: 2, max: 5},
                                            {min: 0, max: 2},
                                        ],
                                        inRange: {
                                            color: ['DarkGreen','SeaGreen','SpringGreen','#ffff00','#ff7d40','#ff0000','#802a2a']
                                        },
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    geo: {
                                        map: 'china',
                                        label: {
                                            emphasis: {
                                                show: false
                                            }
                                        },
                                        roam: true,
                                        itemStyle: {
                                            normal: {
                                                areaColor: 'rgba(128, 128, 128, 0)'
                                            },
                                            emphasis:'disable',
                                            borderType:'dashed',
                                        }
                                    },
                                    series: [{
                                        name: 'AQI',
                                        type: 'scatter',
                                        coordinateSystem: 'geo',
                                        data: convertedData,
                                    }],
                                    tooltip: {
                                        show: true,
                                        // formatter: function(params) {
                                        //     return '' + params.data[0] + '′E,' + params.data[1] + '′N<br/>value: ' + params.data[2] + '%<br/>mean:'+params.data[3]+ '<br/>var:' +params.data[4];
                                        // }
                                    }
                                };
                                myChart02.setOption(option);
                                // 遍历数据，找到符合条件的数据项
                                var data = myChart02.getOption().series[0].data;
                                var dataIndexs = [];
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i][2] > 40) {
                                        dataIndexs.push(i);
                                    }
                                }
                                // 定义一个计数器，用于控制闪烁的速度
                                var count = 0;

// 定义一个定时器，用于控制闪烁的频率
                                var timer = setInterval(function() {
                                    // 遍历所有符合条件的数据项，通过 dispatchAction 方法触发 highlight 和 downplay 动作
                                    for (var i = 0; i < dataIndexs.length; i++) {
                                        var dataIndex = dataIndexs[i];
                                        myChart02.dispatchAction({
                                            type: 'highlight',
                                            seriesIndex: 0,
                                            dataIndex: dataIndex,
                                            itemStyle: blinkStyle.itemStyle,
                                            emphasis: blinkStyle.emphasis
                                        });
                                    }

                                    setTimeout(function() {
                                        for (var i = 0; i < dataIndexs.length; i++) {
                                            var dataIndex = dataIndexs[i];
                                            myChart02.dispatchAction({
                                                type: 'downplay',
                                                seriesIndex: 0,
                                                dataIndex: dataIndex
                                            });
                                        }
                                    }, 400);

                                    count++;
                                }, 800);

// 让定时器一直运行，直到页面卸载
                                window.addEventListener('unload', function() {
                                    clearInterval(timer);
                                });
                                myChart02.on('click',async function (params) {
                                    // const CVSName = getCurrentCSV(params.data[1], params.data[0], month);
                                    // console.log(CVSName)
                                    const currentCSV =  await findCSV(params.data[1], params.data[0],month);
                                    downloadFile(currentCSV,'stanvalueCsv');
                                });
                                myChart02.on('mouseover',async function (params) {
                                    const result = await getMeanAndVar(params.data[1], params.data[0], year, month);
                                    myChart02.setOption({
                                        tooltip: {
                                            formatter:function (params) {
                                                return `${params.data[0]}′E,${params.data[1]}′N<br/>value:${params.data[2]}${params.name}<br/>Mean：${result[0]}%<br/>Var：${result[1]}mm`
                                            }
                                        }
                                    })
                                });
                            })


                        //console.log("geoCoordMap:",geoCoordMap);

                    }


                </script>
                <script>
                    function getCompare() {
                        var blinkStyle = {
                            itemStyle: {
                                color: 'red', // 设置闪烁的颜色
                                borderWidth: 1,
                                borderColor: 'yellow',
                                opacity: 1,
                                shadowColor: 'yellow',
                                shadowBlur: 10
                            },
                            emphasis: {
                                itemStyle: {
                                    opacity: 1
                                }
                            }
                        };
                        const year = document.getElementById('year').value;
                        const month = document.getElementById('month').value;
                        //console.log(year, month);
                        /**
                         *
                         * @param jsonObj
                         * @returns {{[p: string]: any}}
                         */
                        const myChart03 = echarts.init(document.getElementById('new01'));
                        function getGeoCoordMap(jsonObj) {
                            let geoCoordMap = new Map();
                            for (let info of jsonObj) {
                                geoCoordMap.set(info.Stanum, [parseInt(info.Lon) / 100, parseInt(info.Lat) / 100])
                                //console.log(info.Stanum,parseInt(info.Lat)/100,parseInt(info.Lon)/100);
                                //console.log(typeof parseInt(info.Lat))
                            }
                            const result = Object.fromEntries(geoCoordMap)
                            return result;
                        }

                        //let geoCoordMap = getGeoCoordMap(json);

                        function getNameValueArr(jsonObj) {
                            let nameValueArr = [];
                            for (let info of jsonObj) {
                                let currentNameValue = new Map();
                                currentNameValue.set('name', info.Stanum);
                                currentNameValue.set('value', info.Rain);
                                const currentResult = Object.fromEntries(currentNameValue)
                                nameValueArr.push(currentResult)
                            }
                            return nameValueArr;
                        }

                        async function getMeanAndVar(N,E,year,month){
                            const filename = `anorain_${year}_pre_${month}.json`;
                            const res = await fetch('anojson/'+filename);
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Mean)
                                    return [info.Mean,info.Var];
                                }
                            }
                            return '';
                        }

                        var convertData = function (data, geoCoordMap) {
                            var res = [];
                            for (var i = 0; i < data.length; i++) {
                                var geoCoord = geoCoordMap[data[i].name];
                                if (geoCoord) {
                                    res.push(geoCoord.concat(data[i].value));
                                }
                            }
                            return res;
                        };
                        async function findPlaceName(N,E){
                            const res = await fetch('anojson/anorain_1961_pre_06.json');
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Stanum)
                                    return info.Stanum;
                                }
                            }
                            return '';
                        }

                        async function findCSV(N,E,month){
                            const placeName = await findPlaceName(N,E);
                            console.log(`${placeName}_${N}′N${E}′E_pre_${month}.csv`)
                            return `${placeName}_${N}′N${E}′E_pre_${month}.csv`;
                        }

                        function downloadFile(filename, doc) {
                            fetch('/' + doc + '/' + filename)
                                .then(response => response.blob())
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    a.click();
                                    window.URL.revokeObjectURL(url);
                                })
                                .catch(error => {
                                    console.error('下载文件失败：', error);
                                });
                        }
                        console.log(year, month)
                        fetch('standAnoJson/Anostand_'+year+'_pre_'+month+'.json')
                            .then((response) => response.json())
                            .then((json) => {
                                let geoCoordMap = getGeoCoordMap(json);
                                let nameValueArray = getNameValueArr(json);
                                //console.log("nameValueArray:", nameValueArray);
                                //console.log(typeof geoCoordMap)
                                var convertedData = convertData(nameValueArray, geoCoordMap);
                                //console.log("convertedData:", convertedData),
                                option = {
                                    title: {
                                        text: '距平百分比标准化图',
                                        subtext: year+'年'+month+'月',
                                        left: 'center',
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    backgroundColor: '#ffffff',
                                    visualMap: {
                                        type:'piecewise',
                                        pieces: [
                                            {min: 3, max: 5},
                                            {min: 2, max: 3},
                                            {min: 1, max: 2},
                                            {min: 0, max: 1},
                                            {min: -1, max: 0},
                                            {min: -2, max: -1},
                                            {min: -3, max: -2},
                                            {min: -5, max: -3},
                                        ],
                                        inRange: {
                                            color: ['DarkGreen','SeaGreen','SpringGreen','#ffff00','#ff7d40','#ff0000','#802a2a']
                                            //color: ['#191970','#0000ff','#a020f0','#ffff00','#ff7d40']
                                            //color: ['#191970','#0000ff','#a020f0','#ffff00','#ff7d40'].reverse()
                                        },
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    geo: {
                                        map: 'china',
                                        label: {
                                            emphasis: {
                                                show: false
                                            }
                                        },
                                        roam: true,
                                        itemStyle: {
                                            normal: {
                                                areaColor: 'rgba(128, 128, 128, 0)'
                                            },
                                            emphasis:'disable',
                                            borderType:'dashed',
                                        }
                                    },
                                    series: [{
                                        name: 'AQI',
                                        type: 'scatter',
                                        coordinateSystem: 'geo',
                                        data: convertedData,
                                    }],
                                    tooltip: {
                                        show: true,
                                        formatter: function(params) {
                                            return '' + params.data[0] + '′E,' + params.data[1] + '′N<br/>value: ' + params.data[2] + '%<br/>mean:'+params.data[3]+ '<br/>var:' +params.data[4];
                                        }
                                    }
                                };

                                myChart03.setOption(option);
                                // 遍历数据，找到符合条件的数据项
                                var data = myChart03.getOption().series[0].data;
                                var dataIndexs = [];
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i][2] > 3 || data[i][2] < -3) {
                                        dataIndexs.push(i);
                                    }
                                }
                                // 定义一个计数器，用于控制闪烁的速度
                                var count = 0;

// 定义一个定时器，用于控制闪烁的频率
                                var timer = setInterval(function() {
                                    // 遍历所有符合条件的数据项，通过 dispatchAction 方法触发 highlight 和 downplay 动作
                                    for (var i = 0; i < dataIndexs.length; i++) {
                                        var dataIndex = dataIndexs[i];
                                        myChart03.dispatchAction({
                                            type: 'highlight',
                                            seriesIndex: 0,
                                            dataIndex: dataIndex,
                                            itemStyle: blinkStyle.itemStyle,
                                            emphasis: blinkStyle.emphasis
                                        });
                                    }

                                    setTimeout(function() {
                                        for (var i = 0; i < dataIndexs.length; i++) {
                                            var dataIndex = dataIndexs[i];
                                            myChart03.dispatchAction({
                                                type: 'downplay',
                                                seriesIndex: 0,
                                                dataIndex: dataIndex
                                            });
                                        }
                                    }, 400);

                                    count++;
                                }, 800);

// 让定时器一直运行，直到页面卸载
                                window.addEventListener('unload', function() {
                                    clearInterval(timer);
                                });
                                myChart03.on('click',async function (params) {
                                    // const CVSName = getCurrentCSV(params.data[1], params.data[0], month);
                                    // console.log(CVSName)
                                    const currentCSV =  await findCSV(params.data[1], params.data[0],month);
                                    downloadFile(currentCSV,'stanvalueCsv');
                                });
                                myChart03.on('mouseover',async function (params) {
                                    const result = await getMeanAndVar(params.data[1], params.data[0], year, month);
                                    myChart03.setOption({
                                        tooltip: {
                                            formatter:function (params) {
                                                return `${params.data[0]}′E,${params.data[1]}′N<br/>value:${params.data[2]}${params.name}<br/>Mean：${result[0]}%<br/>Var：${result[1]}mm`
                                            }
                                        }
                                    })
                                });
                            })


                        //console.log("geoCoordMap:",geoCoordMap);

                    }


                </script>
                <script>
                    function getCompare02() {
                        var blinkStyle = {
                            itemStyle: {
                                color: 'red', // 设置闪烁的颜色
                                borderWidth: 1,
                                borderColor: 'yellow',
                                opacity: 1,
                                shadowColor: 'yellow',
                                shadowBlur: 10
                            },
                            emphasis: {
                                itemStyle: {
                                    opacity: 1
                                }
                            }
                        };
                        const year = document.getElementById('year').value;
                        const month = document.getElementById('month').value;
                        //console.log(year, month);
                        /**
                         *
                         * @param jsonObj
                         * @returns {{[p: string]: any}}
                         */
                        const myChart04 = echarts.init(document.getElementById('new02'));
                        function getGeoCoordMap(jsonObj) {
                            let geoCoordMap = new Map();
                            for (let info of jsonObj) {
                                geoCoordMap.set(info.Stanum, [parseInt(info.Lon) / 100, parseInt(info.Lat) / 100])
                                //console.log(info.Stanum,parseInt(info.Lat)/100,parseInt(info.Lon)/100);
                                //console.log(typeof parseInt(info.Lat))
                            }
                            const result = Object.fromEntries(geoCoordMap)
                            return result;
                        }

                        //let geoCoordMap = getGeoCoordMap(json);

                        function getNameValueArr(jsonObj) {
                            let nameValueArr = [];
                            for (let info of jsonObj) {
                                let currentNameValue = new Map();
                                currentNameValue.set('name', info.Stanum);
                                currentNameValue.set('value', info.Rain);
                                const currentResult = Object.fromEntries(currentNameValue)
                                nameValueArr.push(currentResult)
                            }
                            return nameValueArr;
                        }

                        async function getMeanAndVar(N,E,year,month){
                            const filename = `anorain_${year}_pre_${month}.json`;
                            const res = await fetch('anojson/'+filename);
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Mean)
                                    return [info.Mean,info.Var];
                                }
                            }
                            return '';
                        }

                        var convertData = function (data, geoCoordMap) {
                            var res = [];
                            for (var i = 0; i < data.length; i++) {
                                var geoCoord = geoCoordMap[data[i].name];
                                if (geoCoord) {
                                    res.push(geoCoord.concat(data[i].value));
                                }
                            }
                            return res;
                        };

                        async function findPlaceName(N,E){
                            const res = await fetch('anojson/anorain_1961_pre_06.json');
                            const json = await res.json();
                            for (let info of json) {
                                if(info.Lat / 100 === N && info.Lon / 100 === E){
                                    console.log(info.Stanum)
                                    return info.Stanum;
                                }
                            }
                            return '';
                        }

                        async function findCSV(N,E,month){
                            const placeName = await findPlaceName(N,E);
                            console.log(`${placeName}_${N}′N${E}′E_pre_${month}.csv`)
                            return `${placeName}_${N}′N${E}′E_pre_${month}.csv`;
                        }

                        function downloadFile(filename, doc) {
                            fetch('/' + doc + '/' + filename)
                                .then(response => response.blob())
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    a.click();
                                    window.URL.revokeObjectURL(url);
                                })
                                .catch(error => {
                                    console.error('下载文件失败：', error);
                                });
                        }

                        console.log(year, month)
                        fetch('standPrbJson/Prbstand_'+year+'_pre_'+month+'.json')
                            .then((response) => response.json())
                            .then((json) => {
                                let geoCoordMap = getGeoCoordMap(json);
                                let nameValueArray = getNameValueArr(json);
                                //console.log("nameValueArray:", nameValueArray);
                                //console.log(typeof geoCoordMap)
                                var convertedData = convertData(nameValueArray, geoCoordMap);
                                //console.log("convertedData:", convertedData),
                                option = {
                                    title: {
                                        text: '卡方分布标准化图',
                                        subtext: year+'年'+month+'月',
                                        left: 'center',
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    backgroundColor: '#ffffff',
                                    visualMap: {
                                        type:'piecewise',
                                        pieces: [
                                            {min: 3, max: 5},
                                            {min: 2, max: 3},
                                            {min: 1, max: 2},
                                            {min: 0, max: 1},
                                            {min: -1, max: 0},
                                            {min: -2, max: -1},
                                            {min: -3, max: -2},
                                            {min: -5, max: -3},
                                        ],
                                        inRange: {
                                            color: ['DarkGreen','SeaGreen','SpringGreen','#ffff00','#ff7d40','#ff0000','#802a2a']
                                            //.reverse()
                                        },
                                        textStyle: {
                                            color: '#000000'
                                        }
                                    },
                                    geo: {
                                        map: 'china',
                                        label: {
                                            emphasis: {
                                                show: false
                                            }
                                        },
                                        roam: true,
                                        itemStyle: {
                                            normal: {
                                                areaColor: 'rgba(128, 128, 128, 0)'
                                            },
                                            emphasis:'disable',
                                            borderType:'dashed',
                                        }
                                    },
                                    series: [{
                                        name: 'AQI',
                                        type: 'scatter',
                                        coordinateSystem: 'geo',
                                        data: convertedData,
                                    }],
                                    tooltip: {
                                        show: true,
                                        formatter: function(params) {
                                            return '' + params.data[0] + '′E,' + params.data[1] + '′N<br/>value: ' + params.data[2] + '%<br/>mean:'+params.data[3]+ '<br/>var:' +params.data[4];
                                        }
                                    }
                                };
                                myChart04.setOption(option);
                                // 遍历数据，找到符合条件的数据项
                                var data = myChart04.getOption().series[0].data;
                                var dataIndexs = [];
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i][2] > 3 || data[i][2] < -3) {
                                        dataIndexs.push(i);
                                    }
                                }
                                // 定义一个计数器，用于控制闪烁的速度
                                var count = 0;

// 定义一个定时器，用于控制闪烁的频率
                                var timer = setInterval(function() {
                                    // 遍历所有符合条件的数据项，通过 dispatchAction 方法触发 highlight 和 downplay 动作
                                    for (var i = 0; i < dataIndexs.length; i++) {
                                        var dataIndex = dataIndexs[i];
                                        myChart04.dispatchAction({
                                            type: 'highlight',
                                            seriesIndex: 0,
                                            dataIndex: dataIndex,
                                            itemStyle: blinkStyle.itemStyle,
                                            emphasis: blinkStyle.emphasis
                                        });
                                    }

                                    setTimeout(function() {
                                        for (var i = 0; i < dataIndexs.length; i++) {
                                            var dataIndex = dataIndexs[i];
                                            myChart04.dispatchAction({
                                                type: 'downplay',
                                                seriesIndex: 0,
                                                dataIndex: dataIndex
                                            });
                                        }
                                    }, 400);

                                    count++;
                                }, 800);

// 让定时器一直运行，直到页面卸载
                                window.addEventListener('unload', function() {
                                    clearInterval(timer);
                                });
                                myChart04.on('click',async function (params) {
                                    // const CVSName = getCurrentCSV(params.data[1], params.data[0], month);
                                    // console.log(CVSName)
                                    const currentCSV =  await findCSV(params.data[1], params.data[0],month);
                                    downloadFile(currentCSV,'stanvalueCsv');
                                });
                                myChart04.on('mouseover',async function (params) {
                                    const result = await getMeanAndVar(params.data[1], params.data[0], year, month);
                                    myChart04.setOption({
                                        tooltip: {
                                            formatter:function (params) {
                                                return `${params.data[0]}′E,${params.data[1]}′N<br/>value:${params.data[2]}${params.name}<br/>Mean：${result[0]}%<br/>Var：${result[1]}mm`
                                            }
                                        }
                                    })
                                });

                            })


                        //console.log("geoCoordMap:",geoCoordMap);

                    }


                </script>
                <script>
                    function showDiv(val) {
                        if (val === '0') {
                            document.getElementById('main').style.display = 'block';
                            document.getElementById('prb').style.display = 'block';
                            document.getElementById('new01').style.display = 'none';
                            document.getElementById('new02').style.display = 'none';
                            getRainJson();
                            getPrbJson();
                        } else {
                            document.getElementById('main').style.display = 'none';
                            document.getElementById('prb').style.display = 'none';
                            document.getElementById('new01').style.display = 'block';
                            document.getElementById('new02').style.display = 'block';
                            getCompare();
                            getCompare02();
                        }
                    }
                    function getData(){
                        getRainJson();
                        getPrbJson();
                        getCompare();
                        getCompare02();
                    }
                </script>
</body>


</html>